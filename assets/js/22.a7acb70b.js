(window.webpackJsonp=window.webpackJsonp||[]).push([[22],{191:function(t,e,s){"use strict";s.r(e);var a={props:["target"]},r=s(17),n=Object(r.a)(a,function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"content"},[s("p",[t._v("当你熟悉 Node.js 之后很可能会自己写些小东西放在 VPS 上跑，比如说一个个人的 API 服务，或者是你的网站。这篇文章分享的内容不管你的 app 大小，都相对适用，因为我们的原则是「run it forever and deploy it smartly」。")]),t._v(" "),t._m(0),t._v(" "),s("p",[t._v("首先你需要的是把你的 app 代码从本地上传到 VPS，我们不可能用上个世纪的 ftp 方式上传。我们开发的时候用 git 同步本地仓库和远程仓库的代码，你一定有屡试不爽的感觉，同理，这里我们也将使用 git 来操作。")]),t._v(" "),s("p",[t._v("以下内容都可以用 "),s("a",{attrs:{href:"https://github.com/yyx990803/pod",target:"_blank",rel:"noopener noreferrer"}},[t._v("pod"),s("OutboundLink")],1),t._v(" 这个工具来代替，不过相应的你需要用 "),s("a",{attrs:{href:"https://github.com/Unitech/pm2",target:"_blank",rel:"noopener noreferrer"}},[t._v("PM2"),s("OutboundLink")],1),t._v(" 来管理进程。而这里是个相对 general case。")]),t._v(" "),s("p",[t._v("首先我们确认一下：")]),t._v(" "),t._m(1),t._v(" "),t._m(2),t._v(" "),t._m(3),s("p",[t._v("现在你就拥有了一个只存在版本管理功能，不包含任何 app 源文件的 git 仓库。")]),t._v(" "),t._m(4),t._v(" "),t._m(5),t._v(" "),t._m(6),t._m(7),s("p",[t._v("最后，按下 Ctrl+D 来确认保存。")]),t._v(" "),s("p",[t._v("为了让你有权限执行这个文件，你需要:")]),t._v(" "),t._m(8),t._m(9),t._v(" "),s("p",[t._v("退出 VPS：")]),t._v(" "),t._m(10),s("p",[t._v("在你的 app 目录里执行：")]),t._v(" "),t._m(11),s("p",[t._v("哇哦，搞定了。试着将你的 web app 发布吧，就是简单地提交而已：")]),t._v(" "),t._m(12),t._m(13),t._v(" "),t._m(14),t._v(" "),s("p",[t._v("你需要持久化运行你的 app，因为它很可能在高峰时段 crash 掉，同时你也希望在系统重启之后你的 app 也能自动重启。")]),t._v(" "),s("p",[t._v("你大可参考 "),s("a",{attrs:{href:"http://support.ghost.org/deploying-ghost/#making-ghost-run-forever",target:"_blank",rel:"noopener noreferrer"}},[t._v("Ghost 部署指南"),s("OutboundLink")],1),t._v(" 来达到这个目的。非常完整，我就不再赘述，不过我推荐使用 Supervisor。")]),t._v(" "),s("p",[t._v("你也可以考虑使用 "),s("a",{attrs:{href:"https://nodejs.org/en/docs/guides/nodejs-docker-webapp/",target:"_blank",rel:"noopener noreferrer"}},[t._v("docker"),s("OutboundLink")],1),t._v(" 这个更现代(?)的解决方案。")]),t._v(" "),t._m(15),t._v(" "),s("ul",[s("li",[s("a",{attrs:{href:"https://certsimple.com/blog/deploy-node-on-linux",target:"_blank",rel:"noopener noreferrer"}},[t._v("How to deploy your node app on Linux, 2016 edition"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://www.terlici.com/2015/06/20/running-node-forever.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("Running your Node & Express apps forever, no matter what, with Systemd and PM2"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"http://serverfault.com/questions/191331/should-servers-have-their-timezone-set-to-gmt-utc",target:"_blank",rel:"noopener noreferrer"}},[t._v("Should servers have their timezone set to GMT/UTC?"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://blog.risingstack.com/operating-node-in-production/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Operating Node.js in Production"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://www.digitalocean.com/community/tutorials/how-to-use-haproxy-to-set-up-http-load-balancing-on-an-ubuntu-vps",target:"_blank",rel:"noopener noreferrer"}},[t._v("How To Use HAProxy to Set Up HTTP Load Balancing on an Ubuntu VPS"),s("OutboundLink")],1)]),t._v(" "),s("li",[s("a",{attrs:{href:"https://blog.risingstack.com/node-js-security-tips/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Node.js Security Tips"),s("OutboundLink")],1)])])])},[function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"上传代码"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#上传代码","aria-hidden":"true"}},[this._v("#")]),this._v(" "),e("span",[this._v("上传代码")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("ul",[e("li",[e("code",[this._v("/var/repo")]),this._v(" - 这是 VPS 上存储 git repo 的目录")]),this._v(" "),e("li",[e("code",[this._v("/var/www")]),this._v(" - 这是 VPS 的网站目录")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"在-vps-上创建一个空-repo"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#在-vps-上创建一个空-repo","aria-hidden":"true"}},[this._v("#")]),this._v(" 在 VPS 上创建一个空 repo")])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[this._v("$ "),e("span",{attrs:{class:"token function"}},[this._v("mkdir")]),this._v(" -p /var/repo/app.git\n$ "),e("span",{attrs:{class:"token function"}},[this._v("cd")]),this._v(" /var/repo/app.git\n$ "),e("span",{attrs:{class:"token function"}},[this._v("git")]),this._v(" init --bare\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"部署的钩子"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#部署的钩子","aria-hidden":"true"}},[this._v("#")]),this._v(" 部署的钩子")])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("你需要一个钩子 "),e("code",[this._v("git hook")]),this._v("，也就是在每次本地 git push 之后让它自动把上传的文件拷贝到你的网站目录中。这里我们使用 git 内置的 "),e("code",[this._v("post-receive")]),this._v(" 钩子：")])},function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("$ "),s("span",{attrs:{class:"token function"}},[t._v("cd")]),t._v(" hooks\n"),s("span",{attrs:{class:"token comment"}},[t._v("# 写入内容到这个文件")]),t._v("\n$ "),s("span",{attrs:{class:"token function"}},[t._v("cat")]),t._v(" "),s("span",{attrs:{class:"token operator"}},[t._v(">")]),t._v(" post-receive\n"),s("span",{attrs:{class:"token comment"}},[t._v("# 回车，输入如下内容：")]),t._v("\n")])])])},function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{attrs:{class:"token shebang important"}},[t._v("#!/bin/sh")]),t._v("\n"),s("span",{attrs:{class:"token function"}},[t._v("git")]),t._v(" --work-tree"),s("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v("/var/www/domain.com --git-dir"),s("span",{attrs:{class:"token operator"}},[t._v("=")]),t._v("/var/repo/app.git checkout -f\n"),s("span",{attrs:{class:"token function"}},[t._v("cd")]),t._v(" /var/www/domain.com\n"),s("span",{attrs:{class:"token function"}},[t._v("npm")]),t._v(" "),s("span",{attrs:{class:"token function"}},[t._v("install")]),t._v("\n"),s("span",{attrs:{class:"token comment"}},[t._v("# 这里还可以加一些构建脚本，比如 npm run build")]),t._v("\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[this._v("$ "),e("span",{attrs:{class:"token function"}},[this._v("chmod")]),this._v(" +x post-receive\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h3",{attrs:{id:"本地配置"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#本地配置","aria-hidden":"true"}},[this._v("#")]),this._v(" 本地配置")])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[this._v("$ "),e("span",{attrs:{class:"token keyword"}},[this._v("exit")]),this._v("\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("div",{staticClass:"language-bash extra-class"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[this._v("$ "),e("span",{attrs:{class:"token function"}},[this._v("git")]),this._v(" remote add server ssh://user@yourdomain.com/var/repo/app.git\n")])])])},function(){var t=this,e=t.$createElement,s=t._self._c||e;return s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("$ "),s("span",{attrs:{class:"token function"}},[t._v("git")]),t._v(" add -A\n$ "),s("span",{attrs:{class:"token function"}},[t._v("git")]),t._v(" commit -m "),s("span",{attrs:{class:"token string"}},[t._v('"deploy to server"')]),t._v("\n$ "),s("span",{attrs:{class:"token function"}},[t._v("git")]),t._v(" push server master\n")])])])},function(){var t=this.$createElement,e=this._self._c||t;return e("p",[this._v("然后检查一下 "),e("code",[this._v("/var/www/domain.com")]),this._v(" 吧，你的代码都被同步过去了。")])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"持久运行你的-app"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#持久运行你的-app","aria-hidden":"true"}},[this._v("#")]),this._v(" "),e("span",[this._v("持久运行你的 app")])])},function(){var t=this.$createElement,e=this._self._c||t;return e("h2",{attrs:{id:"延伸阅读"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#延伸阅读","aria-hidden":"true"}},[this._v("#")]),this._v(" "),e("span",[this._v("延伸阅读")])])}],!1,null,null,null);e.default=n.exports}}]);